---
title: "Practical Regression Implementations: Cox, Poisson, and Negative Binomial Models"
author: "<br><br><span style='font-size:25px;'><strong>Lesley Chapman Hannah, Ph.D., M.S.</strong></span><br>College of Graduate Studies<br>Northeast Ohio Medical University"
format:
  revealjs:
    theme: simple
    slide-number: true
    chalkboard: true
    code-fold: false
execute:
  echo: true
  warning: false
  message: false
  error: true
---

```{r}
#| include: false
library(tidyverse)
library(survival)
library(MASS)
set.seed(29)
theme_set(theme_bw())
```

## Overview
<div style="font-size:0.8em">
- This lecture extends the regression framework to new outcome types using the same structure as previously discussed regression models

- Each model answers a different biomedical question by changing the outcome distribution
</div>





# Poisson Regression : Count Outcomes

## Poisson Regression — Research Question(s)

Do patients with chronic obstructive pulmonary disease (COPD)  
experience more acute exacerbations [sudden worsening of respiratory symptoms] per year as baseline lung function (FEV1) decreases?

- Outcome: number of exacerbations in 12 months
- Predictors: FEV1 [Forced Expiratory Volume in 1 second], smoking history

---

## Poisson Regression — Model Statement
<div style="font-size:0.8em">
$$
Y_i \sim \text{Poisson}(\lambda_i), \quad
\log(\lambda_i) = \beta_0 + \beta_1 \text{FEV1}_i + \beta_2 \text{Smoking}_i
$$

- $\lambda_i$: expected number of exacerbations

</div>
---

## Poisson Distribution
<div style="font-size:0.8em">
Poisson likelihood assumes:

- discrete counts (0,1,2,...)
- variance approximately equal to the mean

$$
Yi​∼Poisson(λi​)
$$

Assumptions for each patient:

- $Y_i$ is a count (0, 1, 2, etc.)
- events occur independently
- expected number of events is: $λ_i$
- in the Poisson distribution the mean equals variance
$$
E(Yi​)=Var(Yi​)=λi​
$$


</div>
---

## Poisson Distribution
<div style="font-size:0.5em">
```{r, echo=FALSE}
set.seed(1)

lambda <- 2  # expected number of events
y <- rpois(10000, lambda)

mean(y)
var(y)
library(ggplot2)

ggplot(data.frame(y), aes(x = y)) +
  geom_histogram(binwidth = 1, boundary = -0.5, color = "black") +
  labs(
    x = "Number of events",
    y = "Frequency",
    title = "Poisson-distributed counts (mean = variance)"
  )

```


</div>
---

## Poisson Distribution
<div style="font-size:0.8em">


- average count and variance = 2
- most patients have 0–3 events
- fewer patients have large counts
- distribution is right-skewed
- counts are discrete, not continuous

</div>
---

## Simulated Dataset
```{r, echo=FALSE}
n <- 250
dat_pois <- tibble(
  fev1 = runif(n, 30, 100),
  smoking = rbinom(n, 1, 0.6)
)

lambda <- exp(
  log(1.8) +
  log(0.97) * (dat_pois$fev1 - 70) +
  log(1.4) * dat_pois$smoking
)

dat_pois$exacerbations <- rpois(n, lambda)
```

```{r}
head(dat_pois)
```


---

## Poisson Regression — Model Fit
```{r}
fit_pois <- glm(exacerbations ~ fev1 + smoking,
                family = poisson(),
                data = dat_pois)
summary(fit_pois)
```
---

## Interpreting the Coefficients Table
<div style="font-size:0.8em">

modeled the number of acute COPD exacerbations over 12 months as a function of:

- FEV1 (% predicted): baseline lung function
- smoking status: smoker vs non-smoker

Coefficients Table

- **Estimate**: change in *log* expected count
- **exp(Estimate)**: effect on the rate for a 1-unit change in $X_i$ [i.e.: exacerbation rate]
- **Std. Error**: uncertainty of the estimate
</div>
---

## Interpreting the Coefficients Table
<div style="font-size:0.7em">

Coefficients Table Examples:

Intercept : 2.666

-  exp(2.666)≈14.4
- 14.4 exacerbations per year for a reference patient:
- FEV1 = 0
- non-smoker
- intercept anchors the model and is rarely interpreted

</div>
---

## Interpreting the Coefficients Table
<div style="font-size:0.7em">

Coefficients Table Examples:

FEV1: −0.029

- exp(−0.029)≈0.97
- each 1% increase in FEV1 was associated with a 3% reduction in expected exacerbations

smoking status: 0.342

- exp(0.342)≈1.41
- smokers experience about 41% more acute exacerbations per year than non-smokers

Statistical Significance:

- both FEV1 and smoking have very strong statistical support
- p-values < 0.001 indicate the observed effects are unlikely due to chance under the Poisson model
</div>
---



# Negative Binomial Regression [Overdispersed Counts]

## Negative Binomial — Research Question(s)

Among RNA-seq samples, does sequencing depth predict the number of detected low-abundance transcripts?

- Outcome: number of low-expression genes detected
- Predictors: sequencing depth, RNA integrity score

---

## Negative Binomial — Model Statement
<div style="font-size:0.8em">
$$
Y_i \sim \text{NB}(\mu_i, \theta), \quad
\log(\mu_i) = \beta_0 + \beta_1 \text{Depth}_i + \beta_2 \text{RIN}_i
$$

- $\mu_i$: expected count
  - average number of low-abundance transcripts we expect to detect for sample *i*
- $\theta$: dispersion parameter controlling extra variability around the mean of each sample
</div>
---

## Negative Binomial Distribution
<div style="font-size:0.8em">
Negative binomial distribution:

$$
Y_i∼NB(μ_i,θ)
$$

- $Y_i$: count (0, 1, 2, etc)
- $μ_i$ : expected count
- θ : dispersion parameter that allows more spread than Poisson
- Negative binomial: variance exceeds mean unlike Poisson where variance = mean

</div>
---

## Negative Binomial Distribution
<div style="font-size:0.8em">


```{r, echo=FALSE}

library(tidyverse)
library(ggplot2)

set.seed(29)

# Choose an expected count (mean) and two dispersion values
mu <- 10

theta_small <- 1    # strong overdispersion
theta_large <- 50   # close to Poisson

# Simulate from Negative Binomial:
# In R's parameterization: rnbinom(n, size = theta, mu = mu)
y_small <- rnbinom(5000, size = theta_small, mu = mu)
y_large <- rnbinom(5000, size = theta_large, mu = mu)

# Compare to Poisson with same mean
y_pois  <- rpois(5000, lambda = mu)

# Check mean and variance
summ <- tibble(
  model = c("NegBin (theta=1)", "NegBin (theta=50)", "Poisson"),
  mean  = c(mean(y_small), mean(y_large), mean(y_pois)),
  var   = c(var(y_small),  var(y_large),  var(y_pois))
)
summ

df <- tibble(
  count = c(y_small, y_large, y_pois),
  model = factor(
    rep(c("NegBin (theta=1)", "NegBin (theta=50)", "Poisson"), each = 5000),
    levels = c("Poisson", "NegBin (theta=50)", "NegBin (theta=1)")
  )
)

ggplot(df, aes(x = count, fill = model)) +
  geom_histogram(binwidth = 1, position = "identity", alpha = 0.55, boundary = -0.5) +
  coord_cartesian(xlim = c(0, 40)) +
  labs(
    x = "Count outcome",
    y = "Frequency",
    title = "Negative binomial allows more variability than Poisson (same mean)"
  ) + theme_bw()

```


</div>
---


## Negative Binomial Distribution
<div style="font-size:0.8em">

- three models :
  - Negative Binomial with $\theta$ = 1 and 50
  - Poisson model
-  mean ~10 events per model
- NB $\theta$ = 1 : counts vary widely 
  - samples vary widely and is representative of whats observed in studies
- NB $\theta$ = 50 : variance [11.9] is closer to the mean
  - as θ becomes large $\rightarrow$ negative binomial behaves more and more like Poisson
</div>
---

## Simulated Dataset
```{r, echo=FALSE}
n <- 240
dat_nb <- tibble(
  depth = runif(n, 10, 60),
  rin = runif(n, 6, 10)
)

mu <- exp(
  log(200) +
  log(1.015) * (dat_nb$depth - 35) +
  log(1.2) * (dat_nb$rin - 8)
)

dat_nb$genes_lo_exp <- rnbinom(n, size = 1.1, mu = mu)

head(dat_nb)
```
---

## Negative Binomial Model
<div style="font-size:0.8em">

- modeled the number of low-expression genes detected in an RNA-seq sample as a function of:

  - sequencing depth (e.g., millions of reads)
  - RNA integrity number (RIN)
</div>
---

## Negative Binomial — Model Fit
```{r}
fit_nb <- glm.nb(genes_lo_exp ~ depth + rin, data = dat_nb)
summary(fit_nb)
```
---



## Negative Binomial — Interpreting the Coefficients Table
<div style="font-size:0.5em">

**Intercept**: 3.197

- exp(3.197)≈24.4
- model predicts about 24 low-expression genes detected for a reference sample with:
  - depth = 0
  - RIN = 0
  
**sequencing depth**: 0.0185

- exp(0.0185)≈1.019
- each 1-unit increase in sequencing depth is associated with a 1.9% increase in the expected number of detected low-expression genes
- essentially, higher sequencing depth leads to greater sensitivity of detecting low-abundance transcripts

**RNA integrity number**: 0.192

- exp(0.192)≈1.21
- each 1-unit increase in RIN is associated with a 21% increase in the expected number of detected low-expression genes
- essentially, higher RMA omtegreity reseves fragile transcripts
</div>
---



## Negative Binomial — Interpreting the Coefficients Table
<div style="font-size:0.8em">

**Statistical Significance**: Both depth and RIN have strong statistical support (p < 0.001)

**Dispersion Parameter**: 
- θ≈1.1
- variance is much larger than the mean
- model overdispersion
- Poisson model would underestimate uncertainty

</div>
---


# Cox Regression : Time-to-Event Outcomes

## Cox Regression — Research Question(s)

Among patients with early-stage breast cancer, does higher tumor proliferation predict shorter time to seeing disease manifest in a patient?

- outcome: time to recurrence 
- predictors: Ki-67 index, age

Definition(s): 
- **recurrence**: first time an event of interest occurs after a defined starting point
- first confirmed return of breast cancer after initial curative treatment
- Ki-67:  tumor proliferation will be defined by presence of Ki-67 a tumor proliferation marker

---

## Cox Regression — Model Statement
<div style="font-size:0.7em">
$$
h(t \mid X_i) = h_0(t) \exp(\beta_1 \text{Ki67}_i + \beta_2 \text{Age}_i)
$$

Key parts in context:

- $h(t∣X_i)$: hazard - rate of an event at a set time
- $h(t)$: risk of recurrence at time $t$
- $h_0(t)$: baseline recurrence risk over time
  - recurrence risk over time for a reference point
- $\beta_1$: log hazard ratio per unit increase in Ki-67
  - how tumor proliferation changes recurrence risk
- $\beta_2$: log hazard ratio per year of age
  - how recurrence risk changes per additional year of age
</div>
---

## Cox Regression — Likelihood
<div style="font-size:0.6em">
Cox model is fit using a **partial likelihood**:

- helps answer: does adding this set of predictors (e.g., Ki-67) improve the model’s explanation of the observed recurrence times by comparing two models:
  - reduced model : model with age only as a predictor
  - full model: model with age and Ki-67
- likelihood ratio compares how well each model explains the data:

$$
\text{Likelihood ratio} = \frac{L(\text{full model})}{L(\text{reduced model})}
$$


</div>

## Cox Regression — Likelihood
<div style="font-size:0.6em">


Coefficients are interpreted via **hazard ratios**:

$$
HR = \exp(\beta)
$$

- HR > 1: higher recurrence risk
- HR < 1: lower recurrence risk
</div>

---

## Simulated dataset
```{r, echo=FALSE}
n <- 220
dat_cox <- tibble(
  age = runif(n, 35, 80),
  ki67 = rlnorm(n, meanlog = 2.8, sdlog = 0.4)
)

lp <- log(1.04) * (dat_cox$ki67 - mean(dat_cox$ki67)) +
      log(1.02) * (dat_cox$age - 55)

rate <- 0.03 * exp(lp)

time_event <- rexp(n, rate)
time_cens  <- rexp(n, 0.02)

dat_cox <- dat_cox |>
  mutate(
    time = pmin(time_event, time_cens),
    status = as.integer(time_event <= time_cens)
  )
```

```{r}
head(dat_cox)
```

---

## Cox Regression Model
<div style="font-size:0.8em">

- modeling time to first breast cancer recurrence as a function of: tumor proliferation [Ki-67] and age
- evaluate patients’ current risk of recurrence over time
- Surv(time, status) : 
  - among patients who have not yet recurred, who is more likely to recur next?
  - factors that define the survival outcome:
    - time: how long the patient was followed
    - status: recurrence[1] vs no recurrence [0]
</div>
---

## Cox Regression — Model Fit
```{r}
fit_cox <- coxph(Surv(time, status) ~ ki67 + age, data = dat_cox)
summary(fit_cox)
```
---



## Cox Regression — Interpreting the Coefficients Table
<div style="font-size:0.6em">
rows represent covariate-adjusted effect on recurrence risk:

- **coef**: effect on the log hazard scale
- **exp(coef)**: hazard ratio
- **se(coef)**: uncertainty in the estimated effect
- **p-value**: evidence that the hazard ratio differs from 1

**Ki-67 hazard ratio**: 

- exp(coef) = 1.033
- given : patients who are the same age recurrence-free at time 0
- patient with a higher Ki-67 value [i.e.: 1 unit higher] has a 3.3% higher current risk of recurrence

**Age hazard ratio**: 

- exp(coef) = 1.015
- an additional year of age confers a 1.5% higher current risk of recurrence

</div>
---


## Cox Regression — Interpreting the Coefficients Table
<div style="font-size:0.6em">

**95% Confidence Intervals**

- 95% confident that each 1-unit increase in Ki-67 increases the recurrence risk by between 1.3% and 5.4%
- 95% confident that each additional year of age increases current recurrence risk by between 0.1% and 2.9%

</div>
---